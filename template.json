{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "gitlabVpc": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "InstanceTenancy": "default"
      }
    },
    "gitlabPublic10000": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "gitlabVpc"
        },
        "CidrBlock": "10.0.0.0/24",
        "AvailabilityZone": "eu-west-1a"
      }
    },
    "gitlabPublic10020": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "gitlabVpc"
        },
        "CidrBlock": "10.0.2.0/24",
        "AvailabilityZone": "eu-west-1b"
      }
    },
    "gitlabPrivate10010": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "gitlabVpc"
        },
        "CidrBlock": "10.0.1.0/24",
        "AvailabilityZone": "eu-west-1a"
      }
    },
    "gitlabPrivate10030": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "gitlabVpc"
        },
        "CidrBlock": "10.0.3.0/24",
        "AvailabilityZone": "eu-west-1b"
      }
    },
    "gitlabPublic": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "gitlabVpc"
        }
      }
    },
    "gitlabGateway": {
      "Type": "AWS::EC2::InternetGateway"
    },
    "attachGitLabGatewayToGitLabVpc" : {
      "Type" : "AWS::EC2::VPCGatewayAttachment",
      "Properties" : {
        "VpcId" : { "Ref" : "gitlabVpc" },
        "InternetGatewayId" : { "Ref" : "gitlabGateway" }
      }
    },
    "gitlabRoute" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "gitlabGateway",
      "Properties" : {
        "RouteTableId" : { "Ref" : "gitlabPublic" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "gitlabGateway" }
      }
    },
    "gitlabPublic10020Assoc" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "gitlabPublic10020" },
        "RouteTableId" : { "Ref" : "gitlabPublic" }
      }
    },
    "gitlabPublic10000Assoc" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "gitlabPublic10000" },
        "RouteTableId" : { "Ref" : "gitlabPublic" }
      }
    },
    "gitlabSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "GitLab Securit Group",
        "VpcId": {
          "Ref": "gitlabVpc"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "gitlabDBSubnetGroup" : {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription" : "Private GitLab Subnet",
        "SubnetIds": [ { "Ref": "gitlabPrivate10010" }, {"Ref": "gitlabPrivate10030" } ]
      }
    },
    "gitlabRDSInstance": {
      "Type" : "AWS::RDS::DBInstance",
      "Properties" : {
        "DBName" : { "Ref" : "gitlab-db-ha" },
        "AllocatedStorage" : { "Ref" : "DBAllocatedStorage" },
        "DBInstanceClass" : { "Ref" : "DBInstanceClass" },
        "Engine" : "PostgreSQL",
        "MasterUsername" : { "Ref" : "gitlab" },
        "MasterUserPassword" : { "Ref" : "DBPassword" },
        "LicenseModel": "postgresql-license",
        "PubliclyAccessible": false,
        "MultiAZ": true,
        "DBSubnetGroupName" : "gitlabDBSubnetGroup"
      }
    }
  }
}
